# RPG Battle（仮称）要件定義書

## 目次
- 1. 概要
- 2. ゴール / 非ゴール
- 3. スコープ（MVP / Phase 2）
- 4. 対象ユーザー / 動作環境
- 5. システム全体像（責務分割）
- 6. 画面・UI要件（ドラクエ風）
- 7. ゲーム仕様（戦闘/階層/育成/保存/戦績）
- 8. マスタデータ（`master_data/*.json`）仕様
- 9. 永続化（DB）設計
- 10. API設計（REST + セッション）
- 11. 実装アーキテクチャ（ファイル構成 / クラス構成）
- 12. 開発フロー（破綻しない進め方）
- 13. 調整ポイント一覧（暫定値の差し替え箇所）

---

## 1. 概要
ターン制コマンドバトルを中心とした RPG ゲームシミュレーターを開発する。キャラクターを強化しながら階層型ダンジョンを進み、長期的な育成と挑戦を提供する。ログイン機能とデータ保存機能により、プレイヤーの進捗を保持し継続プレイを可能にする。

### 1.1 決定済みサマリ（MVP）
- **フロントエンド**: Vue（PC向け、レスポンシブ非対応）
- **バックエンド**: Node.js
- **DB**: MySQL または MariaDB
- **認証**: username + password
- **戦闘**: **サーバが戦闘を実行（サーバ権威）**
- **battle state**: **サーバメモリのみ**で保持（リロード復帰は要件外）
- **保存タイミング**: 全滅時 / メニューでゲーム終了時
- **全滅時の挙動**: 戦績を保存し、進捗（階層/育成/アイテム）を初期化して最初から
- **階層進行**: 「次の戦闘」選択で +1、基本エンドレス（1〜100をデフォルト階層）
- **敵生成**: floorEnemyCost によるコスト編成（101階以降は全敵が候補）

---

## 2. ゴール / 非ゴール
### 2.1 ゴール
- ブラウザ上で、ログイン→キャラ選択→戦闘→強化→階層進行→保存/終了、のループが成立していること
- 100階までを「デフォルト階層」として遊べるバランス調整の土台があること
- 101階以降は難易度が急上昇し、101〜300階では「ほとんどのプレイヤーがゲームオーバー」になる難易度を目標とする
- 全滅時は育成状況をリセットし、再挑戦できること
- 戦績（統計）を保存し、メニューから過去記録やユーザー別ランキングを閲覧できること

### 2.2 非ゴール（MVPではやらない）
- レスポンシブ対応
- リロード復帰（戦闘状態の永続化）
- サウンド（Phase 2以降）
- セキュリティ強化（Phase 2以降）

---

## 3. スコープ（MVP / Phase 2）
### 3.1 MVP（本書の主対象）
- **実行形態**: 実行PC内にサーバを構築して動作（ローカル実行）
- **UI**: ドラクエ風（ログウィンドウ、ステータス枠、敵画像）
- **保存**: 全滅/終了時のみ
- **戦闘**: サーバで実行、battle state はサーバメモリのみ

### 3.2 Phase 2（将来拡張）
- **外部サーバでの実行**（自宅サーバ等）に対応する
  - デプロイ/運用/ネットワーク公開に伴う要件（HTTPS/セキュリティ/バックアップ等）は Phase 2 で検討

---

## 4. 対象ユーザー / 動作環境
- **想定ユーザー**: PCブラウザで遊ぶプレイヤー
- **画面サイズ**: PC画面程度（レスポンシブ非対応）

---

## 5. システム全体像（責務分割）
### 5.1 全体像（論理）
```
プレイヤー（ブラウザ）
    ↓
[ログイン画面] / [新規登録画面]
    ↓
[ゲーム本体]
  PartySelect → Battle → Menu →（次の戦闘 / 終了 / 戦績閲覧）
```

### 5.2 責務分割（MVP確定）
- **クライアント（Vue）**:
  - 画面表示、入力（ボタン/キーボード）、battle state の表示
  - 進捗のローカル保持（保存前）
  - 全滅/終了時に保存APIを呼ぶ
- **サーバ（Node.js）**:
  - 認証（セッション）
  - 進捗保存（DB）
  - 戦績保存（DB）
  - **戦闘の実行**（敵生成/行動順/ダメージ/状態異常/敵AI）
  - **battle state はメモリ保持**

### 5.3 保存タイミング（確定）
- **保存する**: 全滅時 / メニューでゲーム終了時
- **保存しない**: 階層突破時、戦闘終了時

---

## 6. 画面・UI要件（ドラクエ風）
### 6.1 共通
- **入力**:
  - 基本はボタン形式のGUI（ドロップダウンは使用しない）
  - **キーボード操作も受付**（キー割当は調整ポイント）
- **敵表示**: **敵は画像付きで表示**
- **プレイヤーキャラ表示**: パーティ編成画面やステータス欄で **キャラごとのアイコン/画像**を使用

### 6.2 演出・エフェクト（MVP）
- **バトルログ**: 画面下部にメッセージウィンドウを配置し、「〇〇の攻撃！」「△△に10のダメージ！」などの行動履歴を表示
- **ステータス表示**: 戦闘中、パーティ3人のHP/MP（および名前/Lv）を常時表示（ドラクエ風ウィンドウ）
- **ヒット演出**: 敵画像点滅 または 軽いシェイク程度
- **サウンド**: MVPでは無し

### 6.3 画面一覧（MVP）
- Login（ログイン）
- Register（新規登録）
- PartySelect（パーティ選択）
- Battle（戦闘）
- Menu（戦闘後メニュー）
- Stats/Ranking（戦績・ランキング）
- RunDetail（戦績詳細：スナップショット）

### 6.4 画面遷移（確定）
```
[Login]
  ├─ (新規登録へ) → [Register] → (登録成功) → [Login]
  └─ (ログイン成功)
        ↓
    [PartySelect]  ※開始時は必ず実施
        ↓
      [Battle]
        ↓ (勝利)
      [Menu]
        ├─ キャラ再選択 → [PartySelect] → [Battle]
        ├─ アイテム使用 → [Menu]（同画面内で完結）
        ├─ レベルアップ → [Menu]（同画面内で完結）
        ├─ 戦績/ランキング → [Stats/Ranking]
        │                  └─ 記録クリック → [RunDetail] → [Stats/Ranking] → [Menu]
        ├─ 次の戦闘 → （floor + 1）→ [Battle]
        └─ ゲーム終了 → 保存 → [Login]

（全滅）[Battle] → 戦績保存 → 進捗初期化保存 → [Login] → [PartySelect]...
```

---

## 7. ゲーム仕様（戦闘/階層/育成/保存/戦績）
### 7.1 認証（LoginSystem）
#### 7.1.1 新規登録
- ユーザー名＋パスワードでユーザーを作成する
- 初期状態:
  - キャラクター/スキル: 全てレベル1
  - 所持アイテム: 初期所持（8.6）
  - 階層: 1

#### 7.1.2 ログイン
- 入力されたユーザー名＋パスワードで認証する

#### 7.1.3 パスワード保存（暫定: MVP仮）
- **平文で保存**（`password` カラムにそのまま格納）
- Phase 2（外部公開）では見直す前提

### 7.2 パーティ（PartyManager）
- 7キャラ固定から3人を選択する
- 再選択できるタイミング:
  - ゲーム開始時
  - 毎階層突破時（戦闘終了後メニューから）

#### 7.2.1 キャラクター（固定7職）
- 勇者: バランスがよく様々なスキルが使える
- 戦士: 物理攻撃力と防御力が高いが、ほとんど物理攻撃しか使えない
- 魔法使い: 魔法攻撃力が高く全体魔法を使えるが、HPと防御が低い
- 僧侶: 回復中心。**戦闘中のみ使用可能な「死者蘇生」**を唯一習得
- 騎士: HP/防御が高く回復/バフが多いが攻撃力が低い
- 呪術師: 状態異常/バフが多いが攻撃力が低い
- 盗賊: speedが速く会心率高め。一部状態異常/ヒールも可能

### 7.3 戦闘（BattleSystem）
#### 7.3.1 戦闘コマンド（確定）
- たたかう（通常攻撃）: 必須
- じゅもん（スキル）: 必須
- どうぐ（アイテム）: **戦闘中も使用可能**
- ぼうぎょ: 実装する
- にげる: 実装しない

#### 7.3.2 戦闘の実行（MVP確定）
- 戦闘は **サーバが実行**する（クライアントは入力・表示）
- battle state は **サーバメモリのみ**で保持（リロード復帰なし）

#### 7.3.3 行動順（暫定: MVP仮）
- `initiative = speed * 10 + level * 2 + randInt(0, 9)`（戦闘開始時に1回だけ）
- 並び順: `initiative` 降順 → `speed` 降順 → ランダム（同値）
- 「階層ごとに固定」を満たすため、乱数は戦闘開始時に確定し battle state に保持

#### 7.3.4 ダメージ/回復（暫定: MVP仮）
- 前提:
  - 物理: `currentAtk`
  - 魔法: `matk`（魔法防御は `currentDef` を共用）
  - バフ/デバフは `current*` に事前反映
- 通常攻撃（物理）:
  - `base = attacker.currentAtk - floor(defender.currentDef * 0.5)`
  - `lvl = 1 + attacker.level * 0.02`
  - `variance = randFloat(0.90, 1.10)`
  - `damage = floor(max(1, base) * lvl * variance)`
- スキル攻撃:
  - `stat = (powerType == 'magical') ? attacker.matk : attacker.currentAtk`
  - `base = stat * (power / 100) - floor(defender.currentDef * 0.5)`
  - `lvl = 1 + attacker.level * 0.02`
  - `variance = randFloat(0.90, 1.10)`
  - `damage = floor(max(1, base) * lvl * variance)`
- クリティカル:
  - `if randFloat(0, 1) < critRate` then `damage = floor(damage * critMag)`
- 命中:
  - `if randFloat(0, 1) > accuracy` then `damage = 0`（Miss）
- ぼうぎょ:
  - 防御中の対象への被ダメージを `floor(damage * 0.5)`（次の自分の行動開始まで）
- 回復スキル/アイテム:
  - `healing = power * (1 + attacker.level * 0.02) * randFloat(0.95, 1.05)`
  - クリティカルは適用しない（回復は常に成功）
- 属性:
  - MVPでは属性相性は未実装（`element` は保持のみ）

#### 7.3.5 状態異常（暫定: MVP仮）
- ターン開始:
  - DOT: `hp -= value`
  - regen: `hp = min(maxHp, hp + value)`
  - stun: 行動スキップ
  - バフ/デバフ: `current*` 再計算して反映
- ターン終了:
  - `duration -= 1`、`duration <= 0` は削除

#### 7.3.6 死者蘇生（僧侶固有）（暫定: MVP仮）
- 戦闘中のみ、`isDead = true` の対象のみ
- 復活時:
  - HP: `floor(maxHp * 0.30)`（最低1）
  - MP: 0
  - 状態異常: 全解除（`conditions = []`）
  - 行動順: 次に回ってきたタイミングから行動

### 7.4 敵生成（EnemyFactory）（暫定: MVP仮）
#### 7.4.1 ルール（確定）
- 1戦闘あたり敵は1〜5体
- `sum(effectiveCost) <= floorEnemyCost` を満たすように編成
- 101階以降は出現階層制限なし（全敵候補）
- ボスは専用データ。1ターン複数回行動などの特殊行動を許容

#### 7.4.2 暫定パラメータ（MVP仮）
- ボス階層: 10,20,...,100
- floorEnemyCost:
  - `base100(f) = 30 + f * 5 + floor(f / 10) * 10`（1〜100）
  - `base300(f) = base100(100) + (f - 100) * 12 + floor((f - 100) / 10) * 25`（101〜300）
  - `floorEnemyCost(f) = (f <= 100) ? base100(f) : (f <= 300) ? base300(f) : base300(300) + (f - 300) * 15`
- 敵実効コスト:
  - `effectiveCost = baseCost + level * 2`
- 編成アルゴリズム（概要）:
  - 候補をフィルタ → 1〜5体になるまでランダム選出（上限超過しない範囲）
  - ボス階層（1〜100）ではボスを1体確定し、残りを雑魚で埋める

### 7.5 敵AI（暫定: MVP仮）
- 優先順位:
  1. HP30%以下かつ回復スキル所持 → 回復
  2. パーティ全体HP50%以下かつ全体攻撃所持 → 全体攻撃
  3. それ以外: 通常攻撃60% / スキル40%
- 対象選択:
  - 単体: ランダム
  - 全体: 全員
  - 回復/バフ: 自己または最もHPが低い味方

### 7.6 育成（ExperienceSystem）（暫定: MVP仮）
#### 7.6.1 レベル/経験値
- レベル上限: 99
- 獲得経験値（勝利時、パーティ全員）:
  - `gainExp = floorEnemyCost(currentFloor) * 2`
  - 3人に均等配分（端数切り捨て）
- 必要経験値:
  - `nextExp(level) = floor(50 * level * level)`（Lv1→2は50）

#### 7.6.2 スキル育成
- スキルレベル上限: 10
- 使用したスキルに勝利時 `+1`（使用回数分）
- 必要スキル経験値:
  - `skillNextExp(level) = level * 3`
- unlock/prerequisite:
  - マスタJSONの `unlockLevel` / `prerequisiteIds` を満たす場合のみ使用可能

### 7.7 階層進行（確定）
- 1階層 = 1戦闘
- 「次の戦闘」で階層+1
- 1〜100: デフォルト階層
- 101〜300: 難易度急上昇
- 301〜: 300と同じ上昇率で継続（暫定）

### 7.8 保存/全滅（確定）
- 保存タイミング: 全滅時 / ゲーム終了時
- 全滅時:
  - 戦績保存
  - 進捗初期化（階層1、Lv1、初期アイテム）

### 7.9 戦績/ランキング（確定）
- 一覧表示:
  - 最高到達階層
  - 最大ダメージ
- 最大ダメージ定義:
  - **プレイヤーが敵に与えた単発最大ダメージ**
- ランキング:
  - ソート: 最高到達階層 → 最大ダメージ → 新しい記録
- クリックで詳細:
  - その記録の全キャラLv / 全スキルLv

---

## 8. マスタデータ（`master_data/*.json`）仕様
### 8.1 共通仕様（MVP確定）
- 形式: `{ "schemaVersion": 1, "data": [ ... ] }`
- `id`: snake_case
- 参照: `*Id` は `id` 文字列
- `critRate` / `accuracy` / `chance`: 0.0〜1.0
- `imageKey`: `client/src/assets/**/<imageKey>.png` に一致（拡張子除外）
- サーバ起動時にバリデーションし、異常なら起動失敗（MVP推奨）

### 8.2 `characters.json`
```json
{
  "schemaVersion": 1,
  "data": [
    {
      "id": "hero",
      "name": "勇者",
      "description": "バランスがよく様々な系統のスキルが使える",
      "imageKey": "hero",
      "baseStats": { "maxHp": 100, "maxMp": 30, "atk": 15, "matk": 10, "def": 10, "speed": 10 },
      "growthPerLevel": { "maxHp": 8, "maxMp": 3, "atk": 2, "matk": 2, "def": 2, "speed": 1 },
      "initialSkillIds": ["attack_basic"],
      "learnableSkillIds": ["fireball", "heal_small"],
      "tags": ["balanced"]
    }
  ]
}
```
- ステータス算出（暫定）: `base + (level - 1) * growth`

### 8.3 `skills.json`
```json
{
  "schemaVersion": 1,
  "data": [
    {
      "id": "fireball",
      "name": "ファイアボール",
      "description": "敵単体に魔法ダメージ",
      "skillType": "attack",
      "targetType": "enemy",
      "range": "single",
      "power": 120,
      "powerType": "magical",
      "element": "fire",
      "scaling": "matk",
      "critRate": 0.05,
      "critMag": 1.5,
      "cost": 5,
      "costType": "mp",
      "accuracy": 0.95,
      "conditions": [
        { "conditionId": "burn", "chance": 0.2, "durationOverride": 2 }
      ],
      "unlockLevel": 3,
      "prerequisiteIds": [],
      "isPassive": false
    }
  ]
}
```

### 8.4 `items.json`
```json
{
  "schemaVersion": 1,
  "data": [
    {
      "id": "potion",
      "name": "ポーション",
      "description": "味方単体のHPを回復",
      "type": "potion",
      "target": "ally",
      "battleUsable": true,
      "maxStack": 99,
      "effect": { "kind": "heal_hp", "power": 30 }
    }
  ]
}
```

### 8.5 `conditions.json`
```json
{
  "schemaVersion": 1,
  "data": [
    {
      "id": "poison",
      "name": "毒",
      "conditionType": "dot",
      "stat": "hp",
      "value": 5,
      "valueType": "add",
      "duration": 3
    }
  ]
}
```

### 8.6 `enemies.json`
```json
{
  "schemaVersion": 1,
  "data": [
    {
      "id": "slime_a",
      "name": "スライム",
      "imageKey": "slime_01",
      "baseCost": 10,
      "appearMinFloor": 1,
      "appearMaxFloor": 15,
      "isBoss": false,
      "baseStats": { "maxHp": 50, "maxMp": 0, "atk": 8, "matk": 0, "def": 5, "speed": 6 },
      "growthPerLevel": { "maxHp": 5, "maxMp": 0, "atk": 1, "matk": 0, "def": 1, "speed": 1 },
      "skillIds": ["attack_basic"],
      "aiProfile": { "type": "default" }
    }
  ]
}
```
- 敵レベル（暫定）: `enemyLevel = max(1, floor(currentFloor / 2))`

### 8.7 初期所持アイテム（暫定）
- ポーション: 3
- エーテル: 1

---

## 9. 永続化（DB）設計
### 9.1 方針（MVP確定）
- 進捗は `user_state.state_json` に **1 JSONで保持（正規化しない）**

### 9.2 テーブル
- `users`
- `user_state`
- `runs`

### 9.3 DDL（案）
```sql
CREATE TABLE users (
  id BIGINT NOT NULL AUTO_INCREMENT,
  username VARCHAR(32) NOT NULL,
  password VARCHAR(255) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uq_users_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user_state (
  user_id BIGINT NOT NULL,
  current_floor INT NOT NULL DEFAULT 1,
  state_json JSON NOT NULL,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id),
  CONSTRAINT fk_user_state_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE runs (
  id BIGINT NOT NULL AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  ended_reason ENUM('game_over','quit') NOT NULL,
  start_at DATETIME NULL,
  end_at DATETIME NULL,
  max_floor_reached INT NOT NULL,
  max_damage INT NOT NULL DEFAULT 0,
  run_stats_json JSON NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_runs_user_id_created_at (user_id, created_at),
  KEY idx_runs_rank_floor_damage (max_floor_reached, max_damage),
  CONSTRAINT fk_runs_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 9.4 ランキングクエリ（案）
```sql
SELECT
  u.id AS user_id,
  u.username,
  MAX(r.max_floor_reached) AS best_floor,
  MAX(r.max_damage) AS best_damage
FROM users u
JOIN runs r ON r.user_id = u.id
GROUP BY u.id, u.username
ORDER BY best_floor DESC, best_damage DESC, MAX(r.created_at) DESC;
```

---

## 10. API設計（REST + セッション）
### 10.1 認証
- `POST /api/auth/register`
- `POST /api/auth/login`
- `POST /api/auth/logout`

### 10.2 進捗
- `GET /api/state`
- `PUT /api/state`（終了時/全滅時のみ）

### 10.3 戦績/ランキング
- `POST /api/runs`
- `GET /api/runs`
- `GET /api/ranking`

### 10.4 戦闘（サーバ権威）
- `POST /api/battle/start`
- `POST /api/battle/act`
- `GET /api/battle/:battleId`

### 10.5 保存呼び出しタイミング（確定）
- ゲーム終了:
  - `POST /api/runs`（quit）
  - `PUT /api/state`
- 全滅:
  - `POST /api/runs`（game_over）
  - 進捗初期化
  - `PUT /api/state`

---

## 11. 実装アーキテクチャ（ファイル構成 / クラス構成）
### 11.1 ファイル構成（推奨）
```
rpg_battle/
  client/
    src/
      assets/
        enemies/
        ui/
      components/
      pages/
      router/
      store/
      services/
      types/
  server/
    src/
      api/
      auth/
      db/
      game/
      master/
      validation/
  shared/
    types/
  master_data/
    characters.json
    skills.json
    items.json
    conditions.json
    enemies.json
  要件定義.md
  readme.md
```

### 11.2 クラス/モジュール構成（要点）
- サーバ:
  - `BattleService`, `EnemyFactory`, `TurnManager`, `DamageCalculator`, `ConditionSystem`, `EnemyAI`, `ExperienceService`
  - `BattleMemoryStore`（メモリ保持）
  - `UserRepository`, `UserStateRepository`, `RunRepository`
  - `AuthController`, `StateController`, `BattleController`, `RunController`, `RankingController`
- クライアント:
  - `ApiClient`
  - `AuthStore`, `UserStateStore`, `BattleViewStore`, `StatsStore`
  - `LoginPage`, `RegisterPage`, `PartySelectPage`, `BattlePage`, `MenuPage`, `StatsRankingPage`, `RunDetailPage`

---

## 12. 開発フロー（破綻しない進め方）
### 12.1 方針
- 縦に切って「動くもの」を早く作る（登録→戦闘→終了保存）
- UIより先にサーバ戦闘（battle/start→battle/act）を通す
- マスタJSON/進捗JSONの変更に強い設計を優先する

### 12.2 推奨実装順
1. 土台（repo構成、DB接続、セッション、マスタロード）
2. 認証/進捗（register/login/state）
3. 戦闘API（start/act + メモリ保持）
4. クライアント導線（Login→PartySelect→Battle→Menu）
5. 戦績/ランキング（runs/ranking + 詳細表示）

### 12.3 動作確認チェック
- 登録→ログイン→state取得
- battle/start→battle/actで勝敗が出る
- 全滅で戦績保存 + 進捗初期化
- 終了で戦績保存 + 進捗保存

---

## 13. 調整ポイント一覧（暫定値の差し替え箇所）
- キーボード操作のキー割当
- 行動順計算式（7.3.3）
- ダメージ/回復/防御の係数（7.3.4）
- 状態異常の効果量/適用順（7.3.5 / 8.5）
- 敵レベル式/敵AI/敵コスト/難易度曲線（7.4/7.5/8.6）
- 経験値/スキル育成曲線（7.6）

